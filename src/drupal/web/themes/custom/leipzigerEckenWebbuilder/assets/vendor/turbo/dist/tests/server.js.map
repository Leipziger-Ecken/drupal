{"version":3,"file":"server.js","sources":["../../src/tests/server.ts"],"sourcesContent":["import { Response, Router } from \"express\"\nimport multer from \"multer\"\nimport path from \"path\"\n\nconst router = Router()\nconst streamResponses: Set<Response> = new Set\n\nrouter.use(multer().none())\n\nrouter.post(\"/redirect\", (request, response) => {\n  const path = request.body.path ?? \"/src/tests/fixtures/one.html\"\n  response.redirect(303, path)\n})\n\nrouter.post(\"/reject\", (request, response) => {\n  const { status } = request.body\n  const fixture = path.join(__dirname, `../../src/tests/fixtures/${status}.html`)\n\n  response.status(parseInt(status || \"422\", 10)).sendFile(fixture)\n})\n\nrouter.post(\"/messages\", (request, response) => {\n  const { content, status, type } = request.body\n  if (typeof content == \"string\") {\n    receiveMessage(content)\n    if (type == \"stream\") {\n      response.type(\"text/vnd.turbo-stream.html; charset=utf-8\")\n      response.send(renderMessage(content))\n    } else {\n      response.sendStatus(parseInt(status || \"201\", 10))\n    }\n  } else {\n    response.sendStatus(422)\n  }\n})\n\nrouter.put(\"/messages/:id\", (request, response) => {\n  const { content, type } = request.body\n  const { id } = request.params\n  if (typeof content == \"string\") {\n    receiveMessage(content)\n    if (type == \"stream\") {\n      response.type(\"text/vnd.turbo-stream.html; charset=utf-8\")\n      response.send(renderMessage(id + \": \" + content))\n    } else {\n      response.sendStatus(200)\n    }\n  } else {\n    response.sendStatus(422)\n  }\n})\n\nrouter.get(\"/messages\", (request, response) => {\n  response.set({\n    \"Cache-Control\": \"no-cache\",\n    \"Content-Type\": \"text/event-stream\",\n    \"Connection\": \"keep-alive\"\n  })\n\n  response.on(\"close\", () => {\n    streamResponses.delete(response)\n    response.end()\n  })\n\n  response.flushHeaders()\n  response.write(\"data:\\n\\n\")\n  streamResponses.add(response)\n})\n\nfunction receiveMessage(content: string) {\n  const data = renderSSEData(renderMessage(content))\n  for (const response of streamResponses) {\n    intern.log(\"delivering message to stream\", response.socket?.remotePort)\n    response.write(data)\n  }\n}\n\nfunction renderMessage(content: string) {\n  return `\n    <turbo-stream action=\"append\" target=\"messages\"><template>\n      <div class=\"message\">${escapeHTML(content)}</div>\n    </template></turbo-stream>\n  `\n}\n\nfunction renderSSEData(data: any) {\n  return `${data}`.split(\"\\n\").map(line => \"data:\" + line).join(\"\\n\") + \"\\n\\n\"\n}\n\nfunction escapeHTML(html: string) {\n  return html.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\")\n}\n\nexport const TestServer = router\n"],"names":["Router","multer","path"],"mappings":"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"}